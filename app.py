import streamlit as st
import pandas as pd
import hashlib
from utils.google_sheets import (
    read_sheet_to_dataframe,
    get_user_by_login,
    register_user,
    update_row_in_sheet,
    delete_row_in_sheet
)

# ==================================================
# CONFIGURA√á√ïES
# ==================================================
SPREADSHEET_URL = "https://docs.google.com/spreadsheets/d/1VZpV97NIhd16jAyzMpVE_8VhSs-bSqi4DXmySsx2Kc4/edit#gid=761491838"
WORKSHEET_DATA = "Cronograma"
WORKSHEET_USERS = "Usu√°rios"

# Configura√ß√£o da p√°gina
st.set_page_config(
    page_title="Sistema de Cronograma", 
    layout="wide",
    page_icon="üìÖ"
)

# ==================================================
# FUN√á√ïES DE AUTENTICA√á√ÉO
# ==================================================
def hash_password(password):
    """Cria hash SHA-256 da senha"""
    return hashlib.sha256(password.encode()).hexdigest()

def check_login(login, password):
    """Verifica as credenciais do usu√°rio"""
    user = get_user_by_login(SPREADSHEET_URL, WORKSHEET_USERS, login)
    if user and user['Senha'] == hash_password(password):
        return True, user
    return False, None

def show_login_form():
    """Exibe o formul√°rio de login"""
    st.title("üîí Acesso ao Sistema")
    
    with st.form("login_form"):
        login = st.text_input("Login")
        password = st.text_input("Senha", type="password")
        submitted = st.form_submit_button("Entrar")
        
        if submitted:
            if not login or not password:
                st.error("Preencha todos os campos!")
            else:
                success, user = check_login(login, password)
                if success:
                    st.session_state['logged_in'] = True
                    st.session_state['user'] = user
                    st.rerun()
                else:
                    st.error("Login ou senha incorretos!")
    
    if st.button("N√£o tem conta? Cadastre-se"):
        st.session_state['show_register'] = True
        st.rerun()

def show_register_form():
    """Exibe o formul√°rio de cadastro"""
    st.title("üìù Cadastro de Usu√°rio")
    
    with st.form("register_form"):
        col1, col2 = st.columns(2)
        with col1:
            login = st.text_input("Login*")
            password = st.text_input("Senha*", type="password")
        with col2:
            email = st.text_input("Email*")
            confirm_password = st.text_input("Confirmar Senha*", type="password")
        
        user_type = st.selectbox("Tipo de Usu√°rio", ["Usu√°rio", "Administrador"])
        
        submitted = st.form_submit_button("Cadastrar")
        
        if submitted:
            if not all([login, email, password, confirm_password]):
                st.error("Preencha todos os campos obrigat√≥rios!")
            elif password != confirm_password:
                st.error("As senhas n√£o coincidem!")
            elif len(password) < 6:
                st.error("A senha deve ter pelo menos 6 caracteres")
            else:
                user_data = {
                    'Login': login,
                    'Email': email,
                    'Senha': hash_password(password),
                    'Tipo de Usu√°rio': user_type
                }
                success, message = register_user(SPREADSHEET_URL, WORKSHEET_USERS, user_data)
                if success:
                    st.success("Cadastro realizado! Fa√ßa login.")
                    st.session_state['show_register'] = False
                    st.rerun()
                else:
                    st.error(message)
    
    if st.button("Voltar para Login"):
        st.session_state['show_register'] = False
        st.rerun()

# ==================================================
# FUN√á√ïES PRINCIPAIS DO SISTEMA
# ==================================================
@st.cache_data(ttl=300)
def load_data(user_email=None):
    """Carrega os dados do cronograma com filtro opcional por e-mail"""
    return read_sheet_to_dataframe(
        SPREADSHEET_URL, 
        WORKSHEET_DATA,
        user_email
    )

def get_filter_options(df, column):
    """Gera op√ß√µes para os filtros din√¢micos incluindo 'Todos'"""
    try:
        # Remove valores nulos e duplicados, converte para string e ordena
        unique_values = df[column].dropna().unique()
        options = ["Todos"] + sorted([str(x) for x in unique_values if x not in [None, "", " "]])
        return options
    except KeyError:
        st.error(f"Coluna '{column}' n√£o encontrada na planilha")
        return ["Todos"]
    except Exception as e:
        st.error(f"Erro ao gerar op√ß√µes para {column}: {str(e)}")
        return ["Todos"]


def show_main_app():
    """Conte√∫do principal ap√≥s login"""
    # Verifica√ß√£o de seguran√ßa
    if 'user' not in st.session_state:
        st.error("Sess√£o inv√°lida. Redirecionando para login...")
        st.session_state.clear()
        st.rerun()
    
    user = st.session_state['user']
    is_admin = user['Tipo de Usu√°rio'] == "Administrador"
    user_email = None if is_admin else user['Email']
    
    # Carrega dados
    df = load_data(user_email)
    
    if df is None or df.empty:
        st.warning("Nenhum dado encontrado")
        return
    
    # Define colunas para filtros (ajuste conforme sua planilha)
    filter_columns = ['Refer√™ncia', 'Setor', 'Respons√°vel', 'Status']
    
    # Se√ß√£o de filtros
    st.header("Filtros Avan√ßados", divider="rainbow")
    filters = create_dynamic_filters(df, filter_columns)
    
    # Aplica filtros
    filtered_df = apply_dynamic_filters(df, filters)
    
    # Exibe resultados
    st.header("Resultados", divider="rainbow")
    st.subheader(f"üìä Total de registros: {len(filtered_df)}")
    
    if not filtered_df.empty:
        for _, row in filtered_df.iterrows():
            with st.container(border=True):
                # Seu c√≥digo de exibi√ß√£o por card
                cols = st.columns([4, 1])
                with cols[0]:
                    st.markdown(f"**Refer√™ncia:** `{row['Refer√™ncia']}`")
                    st.markdown(f"**Descri√ß√£o:** {row['Descri√ß√£o Meta']}")
                with cols[1]:
                    if st.button("Editar", key=f"edit_{row.name}"):
                        handle_edit(row)
    else:
        st.warning("Nenhum registro corresponde aos filtros selecionados")
        
        # ========================================
        # EXIBI√á√ÉO DOS CARDS (CONTAINER APPROACH)
        # ========================================
        st.header("Resultados", divider="rainbow")
        st.subheader(f"üìä Total de registros: {len(filtered_df)}")
        
        if not filtered_df.empty:
            for idx, row in filtered_df.iterrows():
                with st.container(border=True):
                    # Layout do card
                    cols = st.columns([4, 1])
                    
                    # Coluna esquerda: Dados
                    with cols[0]:
                        st.markdown(f"**Refer√™ncia:** `{row['Refer√™ncia']}`")
                        st.markdown(f"**Descri√ß√£o:** {row['Descri√ß√£o Meta']}")
                        st.markdown(f"**Respons√°vel:** {row['Respons√°vel']}")
                        st.markdown(f"**Status:** {row.get('Status', 'N/A')}")
                    
                    # Coluna direita: Bot√µes de a√ß√£o
                    with cols[1]:
                        if st.button("üìù Editar", key=f"edit_{idx}"):
                            st.session_state['editing_row'] = row.to_dict()
                        
                        if st.button("üóëÔ∏è Excluir", key=f"delete_{idx}"):
                            st.session_state['deleting_row'] = row.to_dict()
                        
                        if st.button("üîç Detalhes", key=f"details_{idx}"):
                            st.session_state['viewing_row'] = row.to_dict()
            
            # ========================================
            # MODAIS DE A√á√ÉO (EDITAR/EXCLUIR/DETALHES)
            # ========================================
            if 'editing_row' in st.session_state:
                show_edit_modal(pd.Series(st.session_state['editing_row']))
                
            if 'deleting_row' in st.session_state:
                show_delete_modal(pd.Series(st.session_state['deleting_row']))
                
            if 'viewing_row' in st.session_state:
                show_details_modal(pd.Series(st.session_state['viewing_row']))
        
        else:
            st.warning("Nenhum registro encontrado com os filtros selecionados!")
    
    elif df is not None and df.empty:
        st.warning("Nenhum registro encontrado na planilha!")
    else:
        st.error("Erro ao carregar dados. Verifique sua conex√£o.")

def apply_dynamic_filters(df, filters):
    """Aplica m√∫ltiplos filtros ao DataFrame de forma segura"""
    try:
        filtered_df = df.copy()
        for column, value in filters.items():
            if value != "Todos":
                # Converte ambos os valores para string para compara√ß√£o segura
                filtered_df = filtered_df[filtered_df[column].astype(str) == str(value)]
        return filtered_df
    except KeyError as e:
        st.error(f"Erro: Coluna '{e.args[0]}' n√£o existe na planilha")
        return df
    except Exception as e:
        st.error(f"Erro ao filtrar dados: {str(e)}")
        return df

def create_dynamic_filters(df, filter_columns):
    """Cria os controles de filtro din√¢mico e retorna os valores selecionados"""
    filters = {}
    cols = st.columns(len(filter_columns))
    
    for i, column in enumerate(filter_columns):
        with cols[i]:
            try:
                options = ["Todos"] + sorted(df[column].dropna().unique().tolist())
                filters[column] = st.selectbox(
                    f"Filtrar por {column}",
                    options=options,
                    key=f"filter_{column}"
                )
            except KeyError:
                st.error(f"Coluna '{column}' n√£o encontrada")
                filters[column] = "Todos"
    
    return filters


# ==================================================
# FUN√á√ïES DOS MODAIS
# ==================================================
def show_edit_modal(row):
    """Modal de edi√ß√£o"""
    with st.expander(f"üìù Editando: {row['Refer√™ncia']}", expanded=True):
        with st.form(f"edit_form_{row.name}"):
            # Campos edit√°veis (ajuste conforme suas colunas)
            referencia = st.text_input("Refer√™ncia", value=row['Refer√™ncia'])
            descricao = st.text_area("Descri√ß√£o", value=row['Descri√ß√£o Meta'])
            status = st.selectbox(
                "Status", 
                options=["Em andamento", "Conclu√≠do", "Pendente"],
                index=["Em andamento", "Conclu√≠do", "Pendente"].index(row.get('Status', 'Pendente'))
            )
            
            if st.form_submit_button("üíæ Salvar Altera√ß√µes"):
                try:
                    # Atualiza a planilha
                    updated = update_row_in_sheet(
                        SPREADSHEET_URL,
                        WORKSHEET_DATA,
                        row.name + 2,  # +2 para compensar cabe√ßalho e index 0
                        [referencia, descricao, status]  # Ajuste conforme suas colunas
                    )
                    if updated:
                        st.success("Registro atualizado com sucesso!")
                        st.cache_data.clear()
                        del st.session_state['editing_row']
                        st.rerun()
                except Exception as e:
                    st.error(f"Erro ao atualizar: {str(e)}")
            
            if st.button("‚ùå Cancelar"):
                del st.session_state['editing_row']
                st.rerun()

def show_delete_modal(row):
    """Modal de exclus√£o"""
    with st.expander(f"üóëÔ∏è Excluir: {row['Refer√™ncia']}", expanded=True):
        st.warning("Tem certeza que deseja excluir este registro?")
        st.json(row.to_dict())
        
        if st.button("‚úÖ Confirmar Exclus√£o", type="primary"):
            try:
                deleted = delete_row_in_sheet(
                    SPREADSHEET_URL,
                    WORKSHEET_DATA,
                    row.name + 2
                )
                if deleted:
                    st.success("Registro exclu√≠do com sucesso!")
                    st.cache_data.clear()
                    del st.session_state['deleting_row']
                    st.rerun()
            except Exception as e:
                st.error(f"Erro ao excluir: {str(e)}")
        
        if st.button("‚ùå Cancelar"):
            del st.session_state['deleting_row']
            st.rerun()

def show_details_modal(row):
    """Modal de detalhes"""
    with st.expander(f"üîç Detalhes: {row['Refer√™ncia']}", expanded=True):
        st.json(row.to_dict())
        
        if st.button("‚¨ÖÔ∏è Voltar"):
            del st.session_state['viewing_row']
            st.rerun()

# ==================================================
# PONTO DE ENTRADA
# ==================================================
def main():
    """Fun√ß√£o principal que controla o fluxo da aplica√ß√£o"""
    # Inicializa vari√°veis de sess√£o
    if 'logged_in' not in st.session_state:
        st.session_state['logged_in'] = False
    if 'show_register' not in st.session_state:
        st.session_state['show_register'] = False
    
    # Controle de fluxo
    if not st.session_state['logged_in']:
        if st.session_state['show_register']:
            show_register_form()
        else:
            show_login_form()
    else:
        show_main_app()

if __name__ == "__main__":
    main()
